{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[568],{968:function(e,t,n){\"use strict\";n.r(t);var r=n(56),a=Object(r.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":e.$parent.slotKey}},[n(\"h1\",{attrs:{id:\"writing-a-rule\"}},[n(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#writing-a-rule\"}},[e._v(\"#\")]),e._v(\" Writing a rule\")]),e._v(\" \"),n(\"h3\",{attrs:{id:\"rules-in-rego\"}},[n(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#rules-in-rego\"}},[e._v(\"#\")]),e._v(\" Rules in Rego\")]),e._v(\" \"),n(\"p\",[e._v(\"Rules are written in Rego. When you are writing Rego, you do two things:\")]),e._v(\" \"),n(\"ol\",[n(\"li\",[e._v(\"Write \"),n(\"strong\",[e._v(\"rules\")]),e._v(\" that make policy decisions. A rule is a conditional assignment.\")]),e._v(\" \"),n(\"li\",[e._v(\"organize rules into \"),n(\"strong\",[e._v(\"policies\")]),e._v(\". A policy is a set of rules with a hierarchical name\")])]),e._v(\" \"),n(\"p\",[e._v(\"To learn more about the Policy Language, visit the official \"),n(\"a\",{attrs:{href:\"https://www.openpolicyagent.org/docs/latest/policy-language/\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"OPA Policy Language Documentation Page\"),n(\"OutboundLink\")],1),e._v(\".\")]),e._v(\" \"),n(\"p\",[e._v('{% hint style=\"info\" %}\\nYou can also use the '),n(\"a\",{attrs:{href:\"https://play.openpolicyagent.org\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"OPA Playground\"),n(\"OutboundLink\")],1),e._v(\" to try out Rego, or run examples of this guide.\\n{% endhint %}\")]),e._v(\" \"),n(\"h3\",{attrs:{id:\"how-to-generate-a-new-rule\"}},[n(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#how-to-generate-a-new-rule\"}},[e._v(\"#\")]),e._v(\" How to generate a new rule\")]),e._v(\" \"),n(\"p\",[e._v(\"There are two options to get started:\")]),e._v(\" \"),n(\"ol\",[n(\"li\",[n(\"p\",[e._v(\"Use the \"),n(\"code\",[e._v(\"template\")]),e._v(\" command to generate the required files for writing a rule:\")]),e._v(\" \"),n(\"div\",{staticClass:\"language- extra-class\"},[n(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[n(\"code\",[e._v(\"snyk-iac-rules template --rule <RULE-NAME> --format <hcl2|json|yaml|tf-plan>\\n\")])])]),n(\"p\",[e._v(\"This generates the scaffolding for the rule, including fixture files based on the provided configuration format. For more details, read the \"),n(\"a\",{attrs:{href:\"https://raw.githubusercontent.com/snyk/user-docs/main/docs/sdk-reference.md#template-options\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"documentation about the template command\"),n(\"OutboundLink\")],1),e._v(\".\")])]),e._v(\" \"),n(\"li\",[n(\"p\",[e._v(\"Create a Rego policy from scratch and match the expected file and folder structure on your own:\"),n(\"br\"),e._v(\" \"),n(\"code\",[e._v(\"rules\")]),e._v(\" \"),n(\"br\"),e._v(\" \"),n(\"code\",[e._v(\"└── my_rule\")]),e._v(\" \"),n(\"br\"),e._v(\" \"),n(\"code\",[e._v(\"├── main.rego\")]),e._v(\" \"),n(\"br\"),e._v(\" \"),n(\"code\",[e._v(\"└── main_test.rego\")])])])]),e._v(\" \"),n(\"p\",[e._v('{% hint style=\"info\" %}\\nYou will have to write your own Rego testing framework if you don\\'t use the '),n(\"code\",[e._v(\"template\")]),e._v(\"command.\\n{% endhint %}\")]),e._v(\" \"),n(\"h3\",{attrs:{id:\"structure-of-the-rule\"}},[n(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#structure-of-the-rule\"}},[e._v(\"#\")]),e._v(\" Structure of the rule\")]),e._v(\" \"),n(\"p\",[e._v(\"In Rego, you can write statements that allow or deny a request, such as:\"),n(\"br\"),e._v(\" \"),n(\"code\",[e._v('allow { input.name == \"alice\" }')]),e._v(\" or \"),n(\"code\",[e._v('deny { input.name == \"alice\" }')])]),e._v(\" \"),n(\"p\",[e._v('{% hint style=\"info\" %}\\nIf the '),n(\"strong\",[n(\"code\",[e._v(\"template\")])]),e._v(\" command was used to generate the rules, then the default entry point is \"),n(\"strong\",[n(\"code\",[e._v(\"rules/deny\")])]),e._v(\". To override it and use a different name than \"),n(\"code\",[e._v(\"deny\")]),e._v(\", check the section \"),n(\"RouterLink\",{attrs:{to:\"/snyk/products/snyk-infrastructure-as-code/custom-rules/getting-started-with-the-sdk/bundling-rules.html\"}},[e._v(\"Bundling Rules\")]),e._v(\".\\n{% endhint %}\")],1),e._v(\" \"),n(\"p\",[e._v(\"This is what a generated skeleton of a deny rule looks like when we run \"),n(\"code\",[e._v(\"snyk-iac-rules template --rule new-rule --format hcl2\")]),e._v(\":\")]),e._v(\" \"),n(\"p\",[e._v('{% code title=\"rules/new-rule/main.rego\" %}')]),e._v(\" \"),n(\"div\",{staticClass:\"language- extra-class\"},[n(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[n(\"code\",[e._v('package rules\\n\\ndeny[msg] {\\n\\tresource := input.resource.test[name]\\n\\tresource.todo\\n\\tmsg := {\\n\\t\\t# Mandatory fields\\n\\t\\t\"publicId\": \"new-rule\",\\n\\t\\t\"title\": \"Default title\",\\n\\t\\t\"severity\": \"low\",\\n\\t\\t\"msg\": sprintf(\"input.resource.test[%s].todo\", [name]),\\n\\t\\t# Optional fields\\n\\t\\t\"issue\": \"\",\\n\\t\\t\"impact\": \"\",\\n\\t\\t\"remediation\": \"\",\\n\\t\\t\"references\": [],\\n\\t}\\n}\\n')])])]),n(\"p\",[e._v(\"{% endcode %}\")]),e._v(\" \"),n(\"p\",[e._v('{% hint style=\"warning\" %}\\nYou must follow this format of the '),n(\"strong\",[e._v(\"msg\")]),e._v(\" property to ensure the output correctly displays on the Snyk IaC CLI.\\n{% endhint %}\")]),e._v(\" \"),n(\"p\",[e._v(\"The attributes are:\")]),e._v(\" \"),n(\"ul\",[n(\"li\",[n(\"strong\",[e._v(\"publicId:\")]),e._v(\" a naming convention unique to yourselves, such as COMPANY-001. \"),n(\"strong\",[e._v(\"This should not contain/start with “SNYK-”\")]),e._v(\" to differentiate from the internal Snyk rules.\")]),e._v(\" \"),n(\"li\",[n(\"strong\",[e._v(\"title:\")]),e._v(\" a short title that should summarise the issue.\")]),e._v(\" \"),n(\"li\",[n(\"strong\",[e._v(\"severity:\")]),e._v(\" this can be one of \"),n(\"strong\",[e._v(\"low/medium/high/critical.\")])]),e._v(\" \"),n(\"li\",[n(\"strong\",[e._v(\"msg:\")]),e._v(\" we recommend only changing the resource name and property e.g. \"),n(\"code\",[e._v(\"input.aws_s3_bucket[%s].tags\")]),e._v(\" to match your example. The function \"),n(\"code\",[e._v(\"sprintf\")]),e._v(\" is provided by Rego and enables us to provide a dynamic error message explaining exactly where the issue was found.\")])]),e._v(\" \"),n(\"p\",[e._v(\"The following attributes are optional but can be used to enhance the scan results in the Snyk CLI:\")]),e._v(\" \"),n(\"ul\",[n(\"li\",[n(\"strong\",[e._v(\"issue:\")]),e._v(\" a more detailed string explanation of what the exact issue is.\")]),e._v(\" \"),n(\"li\",[n(\"strong\",[e._v(\"impact:\")]),e._v(\" a more detailed string explanation of what the impact of not resolving this issue is.\")]),e._v(\" \"),n(\"li\",[n(\"strong\",[e._v(\"remediation:\")]),e._v(\" a more detailed string explanation of how to resolve the issue. We recommend providing a code snippet here.\")]),e._v(\" \"),n(\"li\",[n(\"strong\",[e._v(\"references:\")]),e._v(\" you can provide an array of strings with URLs to documentation\")])]),e._v(\" \"),n(\"p\",[e._v(\"The generated test for the rule uses two generated Terraform files to verify if the correct \"),n(\"code\",[e._v(\"msg\")]),e._v(\" field is returned by the rule for allowed and denied fixtures:\")]),e._v(\" \"),n(\"div\",{staticClass:\"language- extra-class\"},[n(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[n(\"code\",[e._v('package rules\\n\\nimport data.lib\\nimport data.lib.testing\\n\\ntest_new_ruleryle {\\n\\t# array containing test cases where the rule is allowed\\n\\tallowed_test_cases := [{\\n\\t\\t\"want_msgs\": [],\\n\\t\\t\"fixture\": \"allowed.tf\",\\n\\t}]\\n\\n\\t# array containing cases where the rule is denied\\n\\tdenied_test_cases := [{\\n\\t\\t\"want_msgs\": [\"input.resource.test[denied].todo\"], # verifies that the correct msg is returned by the denied rule\\n\\t\\t\"fixture\": \"denied.tf\",\\n\\t}]\\n\\n\\ttest_cases := array.concat(allowed_test_cases, denied_test_cases)\\n\\ttesting.evaluate_test_cases(\"new-rule\", \"./rules/new-rule/fixtures\", test_cases)\\n}\\n\\n')])])]),n(\"h3\",{attrs:{id:\"example-of-a-rule\"}},[n(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#example-of-a-rule\"}},[e._v(\"#\")]),e._v(\" Example of a rule\")]),e._v(\" \"),n(\"p\",[e._v('{% hint style=\"info\" %}\\nFor more examples, see'),n(\"RouterLink\",{attrs:{to:\"/snyk/products/snyk-infrastructure-as-code/custom-rules/getting-started-with-the-sdk/examples.html\"}},[e._v(\" Custom Rules Examples\")]),e._v(\".\\n{% endhint %}\")],1),e._v(\" \"),n(\"p\",[e._v(\"For this example, we modified our templated rule to assign a \"),n(\"code\",[e._v(\"msg\")]),e._v(\" when a resource does not have an \"),n(\"code\",[e._v(\"owner\")]),e._v(\" tag:\")]),e._v(\" \"),n(\"p\",[e._v('{% code title=\"rules/my_rule/main.rego\" %}')]),e._v(\" \"),n(\"div\",{staticClass:\"language- extra-class\"},[n(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[n(\"code\",[e._v('package rules\\n\\ndeny[msg] {\\n    resource := input.resource.aws_redshift_cluster[name]\\n    not resource.tags.owner\\n\\t\\n    msg := {\\n        \"publicId\": \"my_rule\",\\n        \"title\": \"Missing an owner from tag\",\\n        \"severity\": \"medium\",\\n        \"msg\": sprintf(\"input.resource.aws_redshift_cluster[%s].tags\", [name]),\\n        \"issue\": \"\",\\n        \"impact\": \"\",\\n        \"remediation\": \"\",\\n        \"references\": [],\\n    }\\n}\\n')])])]),n(\"p\",[e._v(\"{% endcode %}\")]),e._v(\" \"),n(\"h3\",{attrs:{id:\"limitations-notes\"}},[n(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#limitations-notes\"}},[e._v(\"#\")]),e._v(\" Limitations/Notes\")]),e._v(\" \"),n(\"ul\",[n(\"li\",[e._v(\"As we compile Rego policies into Wasm modules, you can only use built-in functions that support Wasm. There is a table at the bottom of the \"),n(\"a\",{attrs:{href:\"https://www.openpolicyagent.org/docs/latest/policy-reference/\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"Policy Reference Documentation\"),n(\"OutboundLink\")],1),e._v(\" that can help you identify those.\")]),e._v(\" \"),n(\"li\",[e._v(\"A rule may be defined multiple times with the same name, either in a file, or in separate files under the same package, e.g: \")])]),e._v(\" \"),n(\"div\",{staticClass:\"language- extra-class\"},[n(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[n(\"code\",[e._v(\"packages rules\\n\\ndeny[msg] {\\n    resource.this\\n}\\n...\\n\\ndeny[msg] {\\n    resource.that\\n}\\n...\\n\")])])]),n(\"p\",[e._v(\"These rules are referred as \"),n(\"code\",[e._v(\"incremental\")]),e._v(\" as each definition is additive. You can read more about Incremental Definitions \"),n(\"a\",{attrs:{href:\"https://www.openpolicyagent.org/docs/latest/policy-language/#incremental-definitions\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"here\"),n(\"OutboundLink\")],1),e._v(\". Note that these same named rules have to return a different value, or OPA will return an error. You can read more about Complete Definitions \"),n(\"a\",{attrs:{href:\"https://www.openpolicyagent.org/docs/latest/policy-language/#complete-definitions\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"here\"),n(\"OutboundLink\")],1),e._v(\". \")]),e._v(\" \"),n(\"p\",[e._v(\"For more complex topics, check \"),n(\"a\",{attrs:{href:\"https://www.openpolicyagent.org/docs/latest/faq/#conflict-resolution\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"how OPA resolves Conflict Resolution\"),n(\"OutboundLink\")],1),e._v(\". \")])])}),[],!1,null,null,null);t.default=a.exports}}]);","extractedComments":[]}