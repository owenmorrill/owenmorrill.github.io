{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[398],{796:function(e,t,n){\"use strict\";n.r(t);var s=n(56),o=Object(s.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":e.$parent.slotKey}},[n(\"h1\",{attrs:{id:\"section-9-unblock-the-prod-deployment\"}},[n(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#section-9-unblock-the-prod-deployment\"}},[e._v(\"#\")]),e._v(\" Section 9: Unblock the PROD Deployment\")]),e._v(\" \"),n(\"h2\",{attrs:{id:\"step-1-fix-the-issue-in-the-service-definition-yaml-file\"}},[n(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#step-1-fix-the-issue-in-the-service-definition-yaml-file\"}},[e._v(\"#\")]),e._v(\" Step 1: Fix the issue in the Service definition YAML file\")]),e._v(\" \"),n(\"p\",[e._v(\"In the Project issues, Snyk calls out the issue identified, its impact, and how it can be resolved. It also highlights the line of code where the issue exists. In this case, an issue was identified in our \"),n(\"code\",[e._v(\"goof-service.yaml\")]),e._v(\" file because the Load Balancer, as currently defined, is open to the world.\")]),e._v(\" \"),n(\"p\",[n(\"img\",{attrs:{src:\"https://partner-workshop-assets.s3.us-east-2.amazonaws.com/snyk-iac-viewissuedetails.png\",alt:\"\"}})]),e._v(\" \"),n(\"p\",[e._v(\"In some scenarios, such as when our load balancer being open to the world is by design because it's a client-facing web application, we can choose to ignore the issue. In this case, let's assume our Kubernetes cluster sits in a VPC, and an external Application Load Balancer is in use. We'll restrict this Kubernetes Load Balancer to the CIDR Block for our imaginary VPC.\")]),e._v(\" \"),n(\"p\",[e._v(\"Open \"),n(\"code\",[e._v(\"goof-service.yaml\")]),e._v(\" with the GitHub Web Editor, and replace the contents with the following:\")]),e._v(\" \"),n(\"div\",{staticClass:\"language-text extra-class\"},[n(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[n(\"code\",[e._v('apiVersion: v1\\nkind: Service\\nmetadata:\\n  name: goof\\nspec:\\n  type: LoadBalancer\\n  loadBalancerSourceRanges:\\n    - \"143.231.0.0/16\"\\n  ports:\\n    - protocol: TCP\\n      port: 80\\n      targetPort: 3001\\n      name: \"http\"\\n    - protocol: TCP\\n      port: 9229\\n      targetPort: 9229\\n      name: \"debug\"\\n  selector:\\n    app: goof\\n    tier: frontend\\n---\\napiVersion: v1\\nkind: Service\\nmetadata:\\n  name: goof-mongo\\nspec:\\n  ports:\\n    - protocol: TCP\\n      port: 27017\\n      targetPort: 27017\\n      name: \"mongo\"\\n  selector:\\n    app: goof\\n    tier: backend\\n')])])]),n(\"p\",[e._v(\"When ready, propose changes by creating a new branch and opening a Pull Request. This will trigger our IaC verification workflow we set up earlier.\")]),e._v(\" \"),n(\"p\",[n(\"img\",{attrs:{src:\"https://partner-workshop-assets.s3.us-east-2.amazonaws.com/gh-iac-editservice.png\",alt:\"\"}})]),e._v(\" \"),n(\"p\",[e._v(\"When checks complete, in the run details for the IaC workflow, we can appreciate that no other issues are present in the \"),n(\"code\",[e._v(\"goof-service.yaml\")]),e._v(\" file.\")]),e._v(\" \"),n(\"p\",[n(\"img\",{attrs:{src:\"https://partner-workshop-assets.s3.us-east-2.amazonaws.com/gh-iac-checkspostfix.png\",alt:\"\"}})]),e._v(\" \"),n(\"p\",[e._v(\"Go ahead and merge the PR. Our CI workflows for the \"),n(\"code\",[e._v(\"develop\")]),e._v(\" branch will now kick on. Once they complete, we can see that in both the GitHub Security Code Scanning results, as well as in the Snyk UI, the issue from our \"),n(\"code\",[e._v(\"goof-service.yaml\")]),e._v(\" has vanished! Well done!\")]),e._v(\" \"),n(\"h2\",{attrs:{id:\"step-2-fix-the-issues-in-the-deployment-manifest\"}},[n(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#step-2-fix-the-issues-in-the-deployment-manifest\"}},[e._v(\"#\")]),e._v(\" Step 2: Fix the issues in the Deployment manifest\")]),e._v(\" \"),n(\"p\",[e._v(\"Now, on to the \"),n(\"code\",[e._v(\"goof-deployment.yaml\")]),e._v(\" file and its 4 blocking issues. This file actually contains two deployment definitions: one for the database, and another for the app's frontend. The four blocking issues are actually two issues, present in both deployments. Let's take a look in the Snyk UI.\")]),e._v(\" \"),n(\"p\",[n(\"img\",{attrs:{src:\"https://partner-workshop-assets.s3.us-east-2.amazonaws.com/snyk-iac-rootissue.png\",alt:\"\"}})]),e._v(\" \"),n(\"p\",[e._v(\"The first issue states that our container is running without root user control. The second issue, in a similar vein, tells us the container runs with potentially unnecessary privileges. We can fix both of these issues by adding a securityContext in our container's spec.\")]),e._v(\" \"),n(\"p\",[e._v(\"{% hint style=\\\"danger\\\" %}\\nThis is a practical example. It's possible your application requires administrative privileges or other explicitly stated privileges. Know your application and its dependencies before arbitrarily making changes to your files, you could break your deployment if you're not careful.\\n{% endhint %}\")]),e._v(\" \"),n(\"p\",[e._v(\"Setting our SecurityContext to \"),n(\"code\",[e._v(\"runAsNonRoot\")]),e._v(\" will require the container to run with a user with a UID other than 0, and dropping capabilities will restrict how our container interacts with the cluster. Using the GitHub Web Editor, modify the goof-deployment file's \"),n(\"code\",[e._v(\"spec\")]),e._v(\" for both deployments.\")]),e._v(\" \"),n(\"h3\",{attrs:{id:\"add-security-context-to-the-app-container\"}},[n(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#add-security-context-to-the-app-container\"}},[e._v(\"#\")]),e._v(\" Add Security Context to the App Container\")]),e._v(\" \"),n(\"div\",{staticClass:\"language-text extra-class\"},[n(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[n(\"code\",[e._v('spec:\\n  containers:\\n    - name: goof-app\\n      image: goof:PROD\\n      ports:\\n        - containerPort: 3001\\n        - containerPort: 9229\\n      env:\\n        - name: DOCKER\\n          value: \"1\"\\n      securityContext:\\n        runAsNonRoot: true\\n        capabilities:\\n          drop: \\n            - all\\n')])])]),n(\"h3\",{attrs:{id:\"add-security-context-to-the-db-container\"}},[n(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#add-security-context-to-the-db-container\"}},[e._v(\"#\")]),e._v(\" Add Security Context to the DB Container\")]),e._v(\" \"),n(\"div\",{staticClass:\"language-text extra-class\"},[n(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[n(\"code\",[e._v(\"spec:\\n  containers:\\n    - name: goof-mongo\\n      image: mongo\\n      ports:\\n       - containerPort: 27017\\n      securityContext:\\n        runAsNonRoot: true\\n        capabilities:\\n          drop:\\n            - all\\n\")])])]),n(\"p\",[e._v(\"{% hint style=\\\"warning\\\" %}\\nIt's possible to set securityContext for both the Pod and the Containers it runs. In this case, we're setting securityContext for the containers. Learn more in the \"),n(\"a\",{attrs:{href:\"https://kubernetes.io/docs/tasks/configure-pod-container/security-context/\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"Kubernetes Documentation\"),n(\"OutboundLink\")],1),e._v(\".\\n{% endhint %}\")]),e._v(\" \"),n(\"p\",[e._v(\"Merge the changes into the \"),n(\"code\",[e._v(\"develop\")]),e._v(\" branch and wait for the CI workflows to run. Like before, the issue counts will be updated in both GitHub Security Code Scanning and the Snyk UI.\")]),e._v(\" \"),n(\"h2\",{attrs:{id:\"step-3-merge-our-changes-into-prod\"}},[n(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#step-3-merge-our-changes-into-prod\"}},[e._v(\"#\")]),e._v(\" Step 3: Merge our changes into PROD\")]),e._v(\" \"),n(\"p\",[e._v(\"Back in Section 7, our Snyk Gate blocked the Pull Request we creates from \"),n(\"code\",[e._v(\"develop\")]),e._v(\" into \"),n(\"code\",[e._v(\"PROD\")]),e._v(\". Now that we've fixed the issues in our files, back in the Pull Request, we can appreciate that our tests re-ran and this time the Snyk Security Gate is pleased with the changes we made.\")]),e._v(\" \"),n(\"p\",[n(\"img\",{attrs:{src:\"https://partner-workshop-assets.s3.us-east-2.amazonaws.com/gh-iac-prodprcheckspass.png\",alt:\"\"}})]),e._v(\" \"),n(\"p\",[e._v(\"With this assurance, we can merge our changes into PROD. Once merged, our CI workflows will re-run for \"),n(\"code\",[e._v(\"PROD\")]),e._v(\". If we had a workflow to re-deploy our application, it would also run.\")]),e._v(\" \"),n(\"p\",[e._v(\"That's it! You reached the end of this lab! Check out the next section to recap what you accomplished.\")])])}),[],!1,null,null,null);t.default=o.exports}}]);","extractedComments":[]}