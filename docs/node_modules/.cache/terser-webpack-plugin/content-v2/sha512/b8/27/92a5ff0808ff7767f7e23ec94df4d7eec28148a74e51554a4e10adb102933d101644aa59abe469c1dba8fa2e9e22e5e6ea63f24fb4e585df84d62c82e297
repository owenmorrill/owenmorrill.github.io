{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[752],{1148:function(e,t,a){\"use strict\";a.r(t);var s=a(56),n=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":e.$parent.slotKey}},[a(\"h1\",{attrs:{id:\"application-scanning-in-your-pipeline\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#application-scanning-in-your-pipeline\"}},[e._v(\"#\")]),e._v(\" Application Scanning in your pipeline\")]),e._v(\" \"),a(\"p\",[e._v(\"The bitbucket-pipelines.yml defines your Pipelines builds configuration. If you're new to Pipelines you can learn more about how to get started \"),a(\"a\",{attrs:{href:\"https://support.atlassian.com/bitbucket-cloud/docs/get-started-with-bitbucket-pipelines/\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"here\"),a(\"OutboundLink\")],1),e._v(\".\")]),e._v(\" \"),a(\"p\",[e._v(\"In this workshop, we have provided you with a sample bitbucket-pipelines.yml file containing distinct steps mapped to our workflow:\")]),e._v(\" \"),a(\"ul\",[a(\"li\",[e._v(\"Build the code\")]),e._v(\" \"),a(\"li\",[e._v(\"Build the docker image\")]),e._v(\" \"),a(\"li\",[e._v(\"Scan the container image\")]),e._v(\" \"),a(\"li\",[e._v(\"Deploy the container image to a registry\")]),e._v(\" \"),a(\"li\",[e._v(\"Deploy the container image to a Kubernetes cluster\")])]),e._v(\" \"),a(\"p\",[e._v(\"Let's start by examining the first steps to build the code and container:\")]),e._v(\" \"),a(\"div\",{staticClass:\"language-yaml extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yaml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[e._v(\"image\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\" atlassian/default\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\"-\")]),e._v(\"image\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[e._v(\"2\")]),e._v(\"\\n\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[e._v(\"build-app\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token important\"}},[e._v(\"&build-app\")]),e._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\"-\")]),e._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[e._v(\"step\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[e._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\" Build and Test\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[e._v(\"caches\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\"-\")]),e._v(\" maven\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[e._v(\"script\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\"-\")]),e._v(\" mvn \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\"-\")]),e._v(\"B verify \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\"-\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\"-\")]),e._v(\"file pom.xml\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[e._v(\"after-script\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\"\\n          \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[e._v(\"# Collect checkstyle results, if any, and convert to Bitbucket Code Insights.\")]),e._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\"-\")]),e._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[e._v(\"pipe\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\" atlassian/checkstyle\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\"-\")]),e._v(\"report\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\"0.2.0\\n\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[e._v(\"atlassian-security-scan\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token important\"}},[e._v(\"&atlassian-security-scan\")]),e._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\"-\")]),e._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[e._v(\"step\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[e._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\" Security Scan\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[e._v(\"script\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[e._v(\"# Run a security scan for sensitive data.\")]),e._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[e._v(\"# See more security tools at https://bitbucket.org/product/features/pipelines/integrations?&category=security\")]),e._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\"-\")]),e._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[e._v(\"pipe\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\" atlassian/git\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\"-\")]),e._v(\"secrets\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\"-\")]),e._v(\"scan\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[e._v(\":\")]),e._v(\"0.4.3\\n\")])])]),a(\"p\",[e._v(\"In this example, we perform a few activities to illustrate a representative pipeline.  The first stage is \"),a(\"strong\",[e._v(\"build-app,\")]),e._v(\" and it's primary purpose is to run a maven build with checkstyle to generate a jar file.  The next stage is entitled \"),a(\"strong\",[e._v(\"atlassian-security-scan\")]),e._v(\" and we utilize the Atlassian pipe to scan for git secrets.  These two steps are include for convenience and illustrative of a best practice to ensure things are working.  We will not cover their details in the workshop, and we encourage you to review if you are interested.\")]),e._v(\" \"),a(\"p\",[e._v(\"The next block includes Snyk scan where we use two pipes to scan and push an image.\")]),e._v(\" \"),a(\"div\",{staticClass:\"language- extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[a(\"code\",[e._v('snyk-scan-push-image: &snyk-scan-push-image\\n  - step:\\n      name: \"Push container image\"\\n      services:\\n        - docker\\n      script:\\n        - docker build -t $IMAGE .\\n#        - docker tag $IMAGE $IMAGE:${BITBUCKET_COMMIT}\\n        - docker tag $IMAGE $IMAGE:latest\\n        - pipe: snyk/snyk-scan:0.5.1\\n          variables:\\n            SNYK_TOKEN: $SNYK_TOKEN\\n            LANGUAGE: \"docker\"\\n            IMAGE_NAME: $IMAGE\\n            TARGET_FILE: \"Dockerfile\"\\n            CODE_INSIGHTS_RESULTS: \"true\"\\n            SEVERITY_THRESHOLD: \"high\"\\n            DONT_BREAK_BUILD: \"true\"\\n            MONITOR: \"true\"\\n        - pipe: atlassian/aws-ecr-push-image:1.1.3\\n          variables:\\n            AWS_ACCESS_KEY_ID: \\'$AWS_ACCESS_KEY_ID\\'\\n            AWS_SECRET_ACCESS_KEY: \\'$AWS_SECRET_ACCESS_KEY\\'\\n            AWS_DEFAULT_REGION: \\'$AWS_DEFAULT_REGION\\'\\n            IMAGE_NAME: $IMAGE\\n#            TAGS: \\'${BITBUCKET_COMMIT}\\'\\n            TAGS: latest\\n')])])]),a(\"p\",[e._v(\"The first part of the script builds the docker image with commands already familiar to docker users.\")]),e._v(\" \"),a(\"p\",[e._v(\"The next block is the \"),a(\"a\",{attrs:{href:\"https://bitbucket.org/product/features/pipelines/integrations?p=snyk/snyk-scan\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"Snyk Scan\"),a(\"OutboundLink\")],1),e._v(\" pipe for Atlassian Bitbuckets, with configuration parameters.  The details for configuring the pipe are available online, but you can see the human-readable names help us easily understand what is going on.  Let's take a closer look at a few of these:\")]),e._v(\" \"),a(\"ol\",[a(\"li\",[a(\"p\",[a(\"code\",[e._v(\"SNYK_TOKEN\")]),e._v(\" is being passed into our pipe as a repository variable previously defined in the [\"),a(\"strong\",[e._v(\"Bitbucket Configuration\")]),e._v(\"]() module.\")])]),e._v(\" \"),a(\"li\",[a(\"p\",[a(\"code\",[e._v(\"PROJECT_FOLDER\")]),e._v(\" is the folder in which the project resides and normally defaults to \"),a(\"code\",[e._v(\".\")]),e._v(\". However, in our example, we have set this to \"),a(\"code\",[e._v(\"app/goof\")]),e._v(\" and\")]),e._v(\" \"),a(\"p\",[e._v(\"are passing this as an \"),a(\"a\",{attrs:{href:\"https://support.atlassian.com/bitbucket-cloud/docs/use-artifacts-in-steps/\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"artifact\"),a(\"OutboundLink\")],1),e._v(\" to other steps in our pipeline.\")])]),e._v(\" \"),a(\"li\",[a(\"p\",[a(\"code\",[e._v(\"CODE_INSIGHTS_RESULTS\")]),e._v(\" defaults to \"),a(\"code\",[e._v(\"false\")]),e._v(\". However, we will want to create \"),a(\"a\",{attrs:{href:\"https://snyk.io/blog/enhanced-security-for-bitbucket-cloud-development/\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"Code Insight report with Snyk\"),a(\"OutboundLink\")],1),e._v(\" test results so we have set this to \"),a(\"code\",[e._v(\"true\")]),e._v(\".\")])]),e._v(\" \"),a(\"li\",[a(\"p\",[a(\"code\",[e._v(\"SEVERITY_THRESHOLD\")]),e._v(\" reports on issues equal or higher of the provided level. The default is \"),a(\"code\",[e._v(\"low\")]),e._v(\" but in our case, we are interested only in \"),a(\"code\",[e._v(\"high\")]),e._v(\" so we have defined this variable accordingly.\")])]),e._v(\" \"),a(\"li\",[a(\"p\",[a(\"code\",[e._v(\"DONT_BREAK_BUILD\")]),e._v(\" the default is \"),a(\"code\",[e._v(\"false\")]),e._v(\" and this is to be expected. Under normal circumstances we would want to break our build if issues our found. However, for the purpose of this workshop we set the value to \"),a(\"code\",[e._v(\"true\")]),e._v(\".\")])])]),e._v(\" \"),a(\"p\",[e._v('{% hint style=\"info\" %}\\nYou can run '),a(\"strong\",[e._v(\"Snyk security scans\")]),e._v(\" on your \"),a(\"em\",[e._v(\"pull requests\")]),e._v(\" and view results in \"),a(\"strong\",[e._v(\"Code Insights\")]),e._v(\" with the help of a brand new \"),a(\"a\",{attrs:{href:\"https://marketplace.atlassian.com/apps/1222359/snyk-for-bitbucket-cloud?hosting=cloud&tab=overview\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"Snyk Security Connect App on the Atlassian Marketplace\"),a(\"OutboundLink\")],1),e._v(\". It's easy to get started and you can install the app with just a few clicks.\\n{% endhint %}\")]),e._v(\" \"),a(\"p\",[e._v(\"The last block is for an EKS deployment.  We include the block in the workshop to complete the picture of a deployment to a destination environment.  The pipeline will automatically deploy the container to the named pipeline based on the declarations below.\")]),e._v(\" \"),a(\"div\",{staticClass:\"language- extra-class\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[a(\"code\",[e._v(\"deploy-image: &deploy-image\\n  - step:\\n      name: \\\"Push container image\\\"\\n      script:\\n      - pipe: atlassian/aws-eks-kubectl-run:2.2.0\\n        variables:\\n          CLUSTER_NAME: $AWS_EKS_CLUSTER\\n          KUBECTL_COMMAND: 'apply'\\n          RESOURCE_PATH: 'k8s'\\n\")])])])])}),[],!1,null,null,null);t.default=n.exports}}]);","extractedComments":[]}